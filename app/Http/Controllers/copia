<?php

namespace App\Http\Controllers;

use App\Models\Comentario;
use App\Models\Juego;
use Illuminate\Http\Request;

class ComentarioController extends Controller
{
    public function store(Request $request, Juego $juego)
    {
    $request->validate([
        'comentario' => 'required|string|max:1000',
        'valoracion' => 'required|numeric|min:1|max:10',
    ]);

    Comentario::create([
        'juego_id' => $juego->id,
        'usuario_id' => auth()->id(),
        'comentario' => $request->comentario,
        'valoracion' => $request->valoracion,
    ]);

    $juego->actualizarRating();
    if ($juego->comentarios()->where('usuario_id', auth()->id())->exists()) {
        return redirect()->back()->withErrors('Ya has valorado este juego.');
    }
    return redirect()->route('juegos.show', $juego)->with('success', 'Comentario y valoración añadidos con éxito.');
    }


}

<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Comentario extends Model
{
    use HasFactory;

    protected $fillable = ['juego_id', 'usuario_id', 'comentario', 'valoracion'];

    public function usuario()
    {
        return $this->belongsTo(Usuario::class);
    }

    public function juego()
    {
        return $this->belongsTo(Juego::class);
    }
}

<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Juego extends Model
{
    use HasFactory;

    protected $fillable = [
        'nombre',
        'descripcion',
        'edicion',
        'num_jugadores_min',
        'num_jugadores_max',
        'edad_recomendada',
        'duracion_aprox',
        'editor',
        'disenador',
        'ano_publicacion',
        'dureza',
        'precio',
        'rating',
        'imagen',
        'stock',
    ];

    public function setImagenAttribute($value)
    {
        if($value && is_file($value)) {
            $this->attributes['imagen'] = base64_encode(file_get_contents($value));
        } else {
        $this->attributes['imagen'] = $value;
        }
    }

    public function getImagenAttribute($value)
    {
        $finfo = finfo_open(FILEINFO_MIME_TYPE);
        $mimeType = finfo_buffer($finfo, base64_decode($value));
        finfo_close($finfo);
        return "data:$mimeType;base64,$value";
    }
    
    public function carritoItems()
    {
        return $this->morphMany(CarritoItem::class, 'producto');
    }

    public function comentarios()
    {
    return $this->hasMany(Comentario::class);
    }

    public function actualizarRating()
    {
    $promedio = $this->comentarios()->avg('valoracion');
    $this->rating = round($promedio, 2);
    $this->save();
    }

}
Tabla comentarios
1	idPrimaria	bigint		UNSIGNED	No	Ninguna		AUTO_INCREMENT	Cambiar Cambiar	Eliminar Eliminar	
Más Más
	2	juego_idÍndice	bigint		UNSIGNED	No	Ninguna			Cambiar Cambiar	Eliminar Eliminar	
Más Más
	3	usuario_idÍndice	bigint		UNSIGNED	No	Ninguna			Cambiar Cambiar	Eliminar Eliminar	
Más Más
	4	comentario	text	utf8mb4_unicode_ci		No				Cambiar Cambiar	Eliminar Eliminar	
Más Más
	5	valoracion	decimal(4,2)			No	Ninguna			Cambiar Cambiar	Eliminar Eliminar	
Más Más
	6	created_at	timestamp			Sí	NULL			Cambiar Cambiar	Eliminar Eliminar	
Más Más
	7	updated_at	timestamp			Sí	NULL			Cambiar Cambiar	Eliminar Eliminar	
Más Más


Tabla juegos
	#	Nombre	Tipo	Cotejamiento	Atributos	Nulo	Predeterminado	Comentarios	Extra	Acción
	1	idPrimaria	bigint		UNSIGNED	No	Ninguna		AUTO_INCREMENT	Cambiar Cambiar	Eliminar Eliminar	
Más Más
	2	nombre	varchar(100)	utf8mb4_unicode_ci		No	Ninguna			Cambiar Cambiar	Eliminar Eliminar	
Más Más
	3	descripcion	text	utf8mb4_unicode_ci		Sí				Cambiar Cambiar	Eliminar Eliminar	
Más Más
	4	edicion	varchar(50)	utf8mb4_unicode_ci		Sí	NULL			Cambiar Cambiar	Eliminar Eliminar	
Más Más
	5	num_jugadores_min	int			No	Ninguna			Cambiar Cambiar	Eliminar Eliminar	
Más Más
	6	num_jugadores_max	int			No	Ninguna			Cambiar Cambiar	Eliminar Eliminar	
Más Más
	7	edad_recomendada	int			No	Ninguna			Cambiar Cambiar	Eliminar Eliminar	
Más Más
	8	duracion_aprox	int			No	Ninguna			Cambiar Cambiar	Eliminar Eliminar	
Más Más
	9	editor	varchar(100)	utf8mb4_unicode_ci		Sí	NULL			Cambiar Cambiar	Eliminar Eliminar	
Más Más
	10	disenador	varchar(100)	utf8mb4_unicode_ci		Sí	NULL			Cambiar Cambiar	Eliminar Eliminar	
Más Más
	11	ano_publicacion	int			Sí	NULL			Cambiar Cambiar	Eliminar Eliminar	
Más Más
	12	dureza	decimal(3,2)			Sí	NULL			Cambiar Cambiar	Eliminar Eliminar	
Más Más
	13	precio	decimal(8,2)			Sí	NULL			Cambiar Cambiar	Eliminar Eliminar	
Más Más
	14	rating	decimal(3,2)			Sí	NULL			Cambiar Cambiar	Eliminar Eliminar	
Más Más
	15	imagen	longtext	utf8mb4_unicode_ci		Sí				Cambiar Cambiar	Eliminar Eliminar	
Más Más
	16	stock	int			Sí	NULL			Cambiar Cambiar	Eliminar Eliminar	
Más Más
	17	oferta	tinyint(1)			No	0			Cambiar Cambiar	Eliminar Eliminar	
Más Más
	18	precio_oferta	decimal(8,2)			Sí	NULL			Cambiar Cambiar	Eliminar Eliminar	
Más Más
	19	created_at	timestamp			Sí	NULL			Cambiar Cambiar	Eliminar Eliminar	
Más Más
	20	updated_at	timestamp			Sí	NULL			Cambiar Cambiar	Eliminar Eliminar	



#	Nombre	Tipo	Cotejamiento	Atributos	Nulo	Predeterminado	Comentarios	Extra	Acción
	1	idPrimaria	bigint		UNSIGNED	No	Ninguna		AUTO_INCREMENT	Cambiar Cambiar	Eliminar Eliminar	
    Más Más
        2	username	varchar(255)	utf8mb4_unicode_ci		No	Ninguna			Cambiar Cambiar	Eliminar Eliminar	
    Más Más
        3	email	varchar(255)	utf8mb4_unicode_ci		No	Ninguna			Cambiar Cambiar	Eliminar Eliminar	
    Más Más
        4	password	varchar(255)	utf8mb4_unicode_ci		No	Ninguna			Cambiar Cambiar	Eliminar Eliminar	
    Más Más
        5	created_at	timestamp			Sí	NULL			Cambiar Cambiar	Eliminar Eliminar	
    Más Más
        6	updated_at	timestamp			Sí	NULL			Cambiar Cambiar	Eliminar Eliminar	
    Más Más
        7	rol	varchar(255)	utf8mb4_unicode_ci		No	usuario			Cambiar Cambiar	Eliminar Eliminar	
    Más Más
    